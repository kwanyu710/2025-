<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‡¹ğŸ‡­ æ›¼è°·ä¹‹æ—… V2</title>
    <link rel="manifest" href="data:application/json;base64,eyJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInN0YXJ0X3VybCI6Ii4vIiwibmFtZSI6IuaZ76Gl6LC35LmL5peFVjIiLCJzaG9ydF9uYW1lIjoi5pnv6KW/VGhhaSIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2BjZG4uanNkZWxpdnIubmV0L2doL3R3aXR0ZXIvdHdlbW9qaUAxNC4wLjIvYXNzZXRzLzcyeDcyLzFmOTk2LnBuZyIsInR5cGVzIjoiaW1hZ2UvcG5nIiwic2l6ZXMiOiI3Mng3MiJ9XX0=">
    <meta name="theme-color" content="#006494">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #006494;
            --accent: #4ECDC4;
            --bg: #F0F2F5;
            --card-bg: #FFFFFF;
            --text-main: #1A1A1A;
            --text-sub: #666666;
            --danger: #FF6B6B;
            --success: #6BCB77;
            --type-spot: #E3F2FD; /* æ™¯é»è— */
            --type-food: #FFF3E0; /* é¤å»³æ©˜ */
            --type-transport: #E8F5E9; /* äº¤é€šç¶  */
        }

        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--text-main); user-select: none; -webkit-user-select: none;}
        input, select, textarea { font-size: 16px; } /* é˜²æ­¢ iOS ç¸®æ”¾ */

        /* Header */
        .header { background: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;}
        .header h1 { margin: 0; font-size: 1.2rem; color: var(--primary); }
        .edit-toggle { background: none; border: 1px solid var(--primary); color: var(--primary); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }
        .edit-toggle.editing { background: var(--primary); color: white; }

        /* Tabs */
        .tabs-wrapper { background: white; padding: 5px 0; overflow-x: auto; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.02); -webkit-overflow-scrolling: touch;}
        .tab-btn { border: none; background: none; padding: 8px 16px; font-size: 0.95rem; color: var(--text-sub); border-radius: 20px; margin: 0 2px; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; font-weight: bold; }

        /* Weather Widget */
        .weather-banner { background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%); color: white; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; margin: 10px 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(79, 172, 254, 0.3); }
        .weather-info { display: flex; align-items: center; gap: 10px; }

        /* Content Area */
        .content-view { display: none; padding: 15px; }
        .content-view.active { display: block; }

        /* Cards */
        .card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; border-left: 5px solid transparent; }
        .card.type-spot { border-left-color: #2196F3; background: linear-gradient(to right, #FAFBFF, #FFF); }
        .card.type-food { border-left-color: #FF9800; background: linear-gradient(to right, #FFFBF5, #FFF); }
        .card.type-transport { border-left-color: #4CAF50; background: linear-gradient(to right, #F5FBF6, #FFF); }
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
        .card-time { font-weight: bold; color: var(--primary); background: #E1F5FE; padding: 2px 8px; border-radius: 8px; font-size: 0.85rem; }
        .card-title { font-size: 1.1rem; font-weight: 700; margin: 5px 0; display: flex; align-items: center; gap: 8px;}
        .card-desc { font-size: 0.95rem; line-height: 1.6; color: var(--text-sub); margin-bottom: 10px; }
        
        /* Highlight Tags */
        .hl-must-eat { color: #D32F2F; background: #FFEBEE; padding: 0 4px; border-radius: 4px; font-weight: bold; font-size: 0.9em; border: 1px solid #FFCDD2; }
        .hl-must-buy { color: #7B1FA2; background: #F3E5F5; padding: 0 4px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .hl-reserve { color: #E65100; border-bottom: 2px solid #FFE0B2; font-weight: bold; }
        .hl-nav { display: inline-block; margin-top: 8px; background: #E8F5E9; color: #2E7D32; padding: 6px 12px; border-radius: 20px; text-decoration: none; font-size: 0.85rem; font-weight: bold; display: flex; align-items: center; gap: 5px; width: fit-content; border: 1px solid #C8E6C9;}

        /* Tools Section */
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .tool-box { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tool-icon { font-size: 2rem; margin-bottom: 5px; display: block; }

        /* Accounting */
        .accounting-panel { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .ledger-select { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-control { flex: 1; padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #FAFAFA; }
        .member-chips { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .chip { padding: 6px 12px; background: #eee; border-radius: 15px; font-size: 0.9rem; cursor: pointer; border: 1px solid transparent; }
        .chip.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .chip.payer { background: var(--accent); color: white; }

        /* Edit Mode Inputs */
        .edit-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px; font-family: inherit; }
        .delete-btn { background: #FFEBEE; color: #D32F2F; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; margin-top: 5px; cursor: pointer; }
        .add-btn { width: 100%; background: #E3F2FD; color: var(--primary); border: 1px dashed var(--primary); padding: 10px; border-radius: 8px; margin-top: 10px; cursor: pointer; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999; }
        .nav-item { border: none; background: none; color: var(--text-sub); font-size: 0.8rem; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.4rem; }

    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸ‡¹ğŸ‡­ æ›¼è°·è‡ªç”±è¡Œ</h1>
        <button class="edit-toggle" onclick="toggleEditMode()">âœï¸ ç·¨è¼¯è¡Œç¨‹</button>
    </div>

    <div class="tabs-wrapper" id="day-tabs">
        </div>

    <div id="main-container">
        <div id="itinerary-view" class="content-view active">
            <div class="weather-banner">
                <div class="weather-info">
                    <span id="weather-icon">â›…</span>
                    <div>
                        <div style="font-weight:bold" id="weather-loc">Bangkok</div>
                        <div style="font-size:0.8rem" id="weather-temp">æ­£åœ¨è¼‰å…¥å¤©æ°£...</div>
                    </div>
                </div>
                <div style="font-size:0.8rem; opacity:0.9;">é™é›¨ç‡ 10%</div>
            </div>

            <div id="itinerary-list">
                </div>
            <button id="add-card-btn" class="add-btn" style="display:none;" onclick="addNewCard()">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</button>
        </div>

        <div id="tools-view" class="content-view">
            <div class="tools-grid">
                <div class="tool-box">
                    <span class="tool-icon">âœˆï¸</span>
                    <h3>èˆªç­è³‡è¨Š</h3>
                    <div style="font-size:0.9rem; text-align:left;">
                        å»: FD235 18:00<br>
                        å›: FD236 14:00
                    </div>
                </div>
                <div class="tool-box">
                    <span class="tool-icon">ğŸ¨</span>
                    <h3>ä½å®¿è³‡è¨Š</h3>
                    <div style="font-size:0.9rem; text-align:left;">
                        B2 å”äººè¡—<br>
                        èŒ‰è‰èŠ± 59 è™Ÿ
                    </div>
                </div>
                <div class="tool-box" style="background:#FFF3E0">
                    <span class="tool-icon">ğŸ†˜</span>
                    <h3>ç·Šæ€¥è¯çµ¡</h3>
                    <a href="tel:1155" style="display:block;color:#E65100;text-decoration:none;">æ—…éŠè­¦å¯Ÿ 1155</a>
                    <a href="tel:191" style="display:block;color:#E65100;text-decoration:none;">å ±è­¦ 191</a>
                </div>
                <div class="tool-box" style="background:#E3F2FD">
                    <span class="tool-icon">ğŸ’µ</span>
                    <h3>åŒ¯ç‡æ›ç®—</h3>
                    <div id="rate-display">1 THB â‰ˆ 0.92 TWD</div>
                </div>
            </div>
        </div>

        <div id="accounting-view" class="content-view">
            <div class="accounting-panel">
                <h3 style="margin-top:0">ğŸ“’ è¨˜å¸³æœ¬</h3>
                <select id="ledger-select" class="ledger-select" onchange="changeLedger()">
                    <option value="main">ä¸»å¸³æœ¬ (å…¬è²»)</option>
                    <option value="shopping">å€‹äººä»£è³¼</option>
                    <option value="add_new">+ æ–°å¢å¸³æœ¬...</option>
                </select>

                <div style="background:#F8F9FA; padding:15px; border-radius:8px;">
                    <div class="form-row">
                        <input type="text" id="exp-name" class="form-control" placeholder="é …ç›® (å¦‚: æ™šé¤)">
                        <input type="number" id="exp-amt" class="form-control" placeholder="é‡‘é¡ (THB)">
                    </div>
                    
                    <div style="font-size:0.9rem; color:#666; margin-bottom:5px;">èª°å…ˆå¢Šä»˜ï¼Ÿ (å–®é¸)</div>
                    <div class="member-chips" id="payer-chips">
                        </div>

                    <div style="font-size:0.9rem; color:#666; margin-bottom:5px; margin-top:10px;">åˆ†çµ¦èª°ï¼Ÿ (å¯å¤šé¸)</div>
                    <div style="margin-bottom:10px;">
                        <button onclick="selectAllMembers()" style="font-size:0.8rem; padding:4px 8px;">å…¨é¸</button>
                    </div>
                    <div class="member-chips" id="beneficiary-chips">
                        </div>

                    <button onclick="addExpense()" style="width:100%; background:var(--primary); color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; margin-top:10px;">æ–°å¢ç´€éŒ„</button>
                </div>
            </div>

            <div id="expense-list">
                </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('itinerary')">
            <span class="nav-icon">ğŸ—ºï¸</span> è¡Œç¨‹
        </button>
        <button class="nav-item" onclick="switchTab('tools')">
            <span class="nav-icon">ğŸ§°</span> è³‡è¨Š
        </button>
        <button class="nav-item" onclick="switchTab('accounting')">
            <span class="nav-icon">ğŸ’¸</span> è¨˜å¸³
        </button>
    </div>

    <script>
        // --- 1. è³‡æ–™çµæ§‹èˆ‡åˆå§‹åŒ– ---
        const defaultMembers = ["æˆ‘", "æ—…ä¼´A", "æ—…ä¼´B", "æ—…ä¼´C"]; // é è¨­æˆå“¡
        
        // é è¨­è¡Œç¨‹è³‡æ–™ (å¦‚æœ LocalStorage æ²’è³‡æ–™å°±ç”¨é€™å€‹)
        const defaultItinerary = {
            "day1": {
                date: "12/23 (äºŒ)",
                location: "Bangkok",
                items: [
                    { type: "transport", time: "18:00", title: "FD235 é£›å¾€æ›¼è°·", desc: "é«˜é›„æ©Ÿå ´å‡ºç™¼ï¼Œ21:30 æŠµé”å»Šæ›¼æ©Ÿå ´ã€‚è¨˜å¾—å¡«å¯«å…¥å¢ƒå¡ã€‚", location: "Don Mueang International Airport" },
                    { type: "transport", time: "22:00", title: "æ¥æ©ŸåŒ…è»Š", desc: "å¾€ B2 å”äººè¡—é£¯åº—ï¼Œè»Šç¨‹ç´„ 30 åˆ†é˜ã€‚", location: "" },
                    { type: "food", time: "23:00", title: "å”äººè¡—å®µå¤œ", desc: "å¿…åƒé™³å„„ç²¿æ¢ï¼Œé‚„å¯ä»¥è²·æ—çœŸé¦™è‚‰ä¹¾ç•¶ä¼´æ‰‹ç¦®ã€‚", location: "Yaowarat Road" }
                ]
            },
            "day2": {
                date: "12/24 (ä¸‰)",
                location: "Bangkok",
                items: [
                    { type: "spot", time: "10:00", title: "çŸ³é¾è»è·¯æ¼«éŠ", desc: "åƒè§€æ–‡é’å°åº—ï¼Œå¿…åƒç‹å­æˆ²é™¢è±¬è‚‰ç²¥ã€‚", location: "Charoen Krung Road" },
                    { type: "spot", time: "14:00", title: "è‡¥ä½›å¯º & é„­ç‹å»Ÿ", desc: "è¨˜å¾—ç©¿è‘—å¾—é«”(æœ‰è¢–è¡£æœ)ã€‚é ç´„ä»£è™Ÿ: KLOOK-12345", location: "Wat Arun" },
                    { type: "food", time: "18:00", title: "River City éƒµè¼ªæ™šé¤", desc: "æ¬£è³æ˜­æŠ«è€¶æ²³å¤œæ™¯ï¼Œååˆ†æµªæ¼«ã€‚", location: "River City Bangkok" }
                ]
            },
            "day3": { date: "12/25 (å››)", location: "Bangkok", items: [] },
            "day4": { date: "12/26 (äº”)", location: "Amphawa", items: [
                { type: "spot", time: "08:00", title: "åŒ…è»Šä¸€æ—¥éŠ", desc: "å‰å¾€ç¾åŠŸéµé“å¸‚å ´èˆ‡ä¸¹å«©èæ°´ä¸Šå¸‚å ´ã€‚", location: "Maeklong Railway Market" }
            ]}
        };

        // ç‹€æ…‹è®Šæ•¸
        let currentDay = "day1";
        let isEditing = false;
        let data = JSON.parse(localStorage.getItem('trip_data')) || defaultItinerary;
        let expenses = JSON.parse(localStorage.getItem('trip_expenses')) || { main: [] };
        let currentLedger = "main";
        let selectedPayer = defaultMembers[0];
        let selectedBeneficiaries = [...defaultMembers];

        // --- 2. æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

        function init() {
            renderDayTabs();
            renderItinerary();
            initAccountingUI();
            fetchWeather(); // æ¨¡æ“¬å¤©æ°£
        }

        // æ¸²æŸ“å¤©æ•¸ Tab
        function renderDayTabs() {
            const container = document.getElementById('day-tabs');
            let html = '';
            Object.keys(data).forEach(key => {
                const day = data[key];
                const activeClass = key === currentDay ? 'active' : '';
                html += `<button class="tab-btn ${activeClass}" onclick="changeDay('${key}')">${day.date}</button>`;
            });
            container.innerHTML = html;
        }

        // åˆ‡æ›å¤©æ•¸
        function changeDay(dayKey) {
            currentDay = dayKey;
            renderDayTabs();
            renderItinerary();
            fetchWeather(); // åˆ‡æ›åœ°é»æ™‚æ›´æ–°å¤©æ°£
        }

        // è‡ªå‹•å°éŠæ–‡å­—åˆ†æ (Highlight)
        function analyzeText(text) {
            if (!text) return "";
            let processed = text;
            // äº®é¡¯è¦å‰‡
            processed = processed.replace(/(å¿…åƒ|å¿…é»|å¿…è²·|æ¨è–¦)/g, '<span class="hl-must-eat">$1</span>');
            processed = processed.replace(/(é ç´„|ä»£è™Ÿ|è¨‚ä½)/g, '<span class="hl-reserve">$1</span>');
            // é€£çµè‡ªå‹•åŒ–
            processed = processed.replace(/(http[s]?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">é€£çµ</a>');
            return processed;
        }

        // æ¸²æŸ“è¡Œç¨‹å¡ç‰‡
        function renderItinerary() {
            const list = document.getElementById('itinerary-list');
            const dayData = data[currentDay].items;
            let html = '';

            dayData.forEach((item, index) => {
                if (isEditing) {
                    // ç·¨è¼¯æ¨¡å¼ä»‹é¢
                    html += `
                    <div class="card" style="border-left-color:#ccc;">
                        <input class="edit-input" value="${item.time || ''}" placeholder="æ™‚é–“" onchange="updateItem('${currentDay}', ${index}, 'time', this.value)">
                        <select class="edit-input" onchange="updateItem('${currentDay}', ${index}, 'type', this.value)">
                            <option value="spot" ${item.type==='spot'?'selected':''}>æ™¯é»</option>
                            <option value="food" ${item.type==='food'?'selected':''}>é¤å»³</option>
                            <option value="transport" ${item.type==='transport'?'selected':''}>äº¤é€š</option>
                        </select>
                        <input class="edit-input" value="${item.title}" placeholder="æ¨™é¡Œ" onchange="updateItem('${currentDay}', ${index}, 'title', this.value)">
                        <textarea class="edit-input" rows="3" placeholder="æè¿° (æ”¯æ´ 'å¿…åƒ' ç­‰é—œéµå­—)" onchange="updateItem('${currentDay}', ${index}, 'desc', this.value)">${item.desc || ''}</textarea>
                        <input class="edit-input" value="${item.location || ''}" placeholder="Google Map åœ°é»é—œéµå­—" onchange="updateItem('${currentDay}', ${index}, 'location', this.value)">
                        <button class="delete-btn" onclick="deleteItem('${currentDay}', ${index})">ğŸ—‘ï¸ åˆªé™¤æ­¤å¡ç‰‡</button>
                    </div>`;
                } else {
                    // ç€è¦½æ¨¡å¼ä»‹é¢
                    const navBtn = item.location ? 
                        `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}" target="_blank" class="hl-nav">ğŸ“ å°èˆªå»é€™è£¡</a>` : '';
                    
                    html += `
                    <div class="card type-${item.type}">
                        <div class="card-header">
                            <span class="card-time">${item.time || 'è¡Œç¨‹'}</span>
                            <span style="font-size:1.2rem">${item.type === 'food' ? 'ğŸ´' : (item.type === 'transport' ? 'ğŸšŒ' : 'ğŸ“·')}</span>
                        </div>
                        <div class="card-title">${item.title}</div>
                        <div class="card-desc">${analyzeText(item.desc)}</div>
                        ${navBtn}
                    </div>`;
                }
            });
            list.innerHTML = html;
        }

        // --- 3. ç·¨è¼¯åŠŸèƒ½ ---
        function toggleEditMode() {
            isEditing = !isEditing;
            const btn = document.querySelector('.edit-toggle');
            const addBtn = document.getElementById('add-card-btn');
            
            if (isEditing) {
                btn.classList.add('editing');
                btn.innerText = "ğŸ’¾ å„²å­˜ä¸¦çµæŸ";
                addBtn.style.display = "block";
            } else {
                btn.classList.remove('editing');
                btn.innerText = "âœï¸ ç·¨è¼¯è¡Œç¨‹";
                addBtn.style.display = "none";
                saveData(); // å„²å­˜åˆ° LocalStorage
            }
            renderItinerary();
        }

        function updateItem(day, index, field, value) {
            data[day].items[index][field] = value;
        }

        function addNewCard() {
            data[currentDay].items.push({ type: 'spot', title: 'æ–°è¡Œç¨‹', desc: '', time: '' });
            renderItinerary();
        }

        function deleteItem(day, index) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ")) {
                data[day].items.splice(index, 1);
                renderItinerary();
            }
        }

        function saveData() {
            localStorage.setItem('trip_data', JSON.stringify(data));
        }

        // --- 4. è¨˜å¸³åŠŸèƒ½ ---
        function initAccountingUI() {
            // ç”Ÿæˆæˆå“¡ Chips
            const payerContainer = document.getElementById('payer-chips');
            const benContainer = document.getElementById('beneficiary-chips');
            
            let payerHtml = '';
            let benHtml = '';

            defaultMembers.forEach(m => {
                payerHtml += `<div class="chip ${m === selectedPayer ? 'payer' : ''}" onclick="selectPayer('${m}')">${m}</div>`;
                benHtml += `<div class="chip ${selectedBeneficiaries.includes(m) ? 'selected' : ''}" onclick="toggleBeneficiary('${m}')">${m}</div>`;
            });

            payerContainer.innerHTML = payerHtml;
            benContainer.innerHTML = benHtml;
            renderExpenses();
        }

        function selectPayer(name) {
            selectedPayer = name;
            initAccountingUI(); // é‡ç¹ª Chips
        }

        function toggleBeneficiary(name) {
            if (selectedBeneficiaries.includes(name)) {
                selectedBeneficiaries = selectedBeneficiaries.filter(n => n !== name);
            } else {
                selectedBeneficiaries.push(name);
            }
            initAccountingUI();
        }

        function selectAllMembers() {
            selectedBeneficiaries = [...defaultMembers];
            initAccountingUI();
        }

        function addExpense() {
            const name = document.getElementById('exp-name').value;
            const amt = parseFloat(document.getElementById('exp-amt').value);
            
            if (!name || !amt) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
            if (selectedBeneficiaries.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åˆ†å¸³äºº");

            const newExp = {
                id: Date.now(),
                name,
                amt,
                payer: selectedPayer,
                for: selectedBeneficiaries
            };

            expenses[currentLedger].unshift(newExp);
            localStorage.setItem('trip_expenses', JSON.stringify(expenses));
            
            // æ¸…ç©º
            document.getElementById('exp-name').value = '';
            document.getElementById('exp-amt').value = '';
            renderExpenses();
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const ledgerData = expenses[currentLedger] || [];
            
            let html = '';
            let total = 0;

            ledgerData.forEach(exp => {
                total += exp.amt;
                const perPerson = Math.round(exp.amt / exp.for.length);
                html += `
                <div style="background:white; padding:10px; margin-bottom:8px; border-radius:8px; border-left:4px solid var(--accent);">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>${exp.name}</span>
                        <span>à¸¿${exp.amt}</span>
                    </div>
                    <div style="font-size:0.85rem; color:#666; margin-top:4px;">
                        ${exp.payer} å…ˆä»˜ â” åˆ†çµ¦: ${exp.for.join(', ')} 
                        (æ¯äºº à¸¿${perPerson})
                    </div>
                </div>`;
            });

            html = `<div style="text-align:center; margin-bottom:15px; font-weight:bold; color:var(--primary);">æœ¬å¸³æœ¬ç¸½æ”¯å‡º: à¸¿${total}</div>` + html;
            list.innerHTML = html;
        }

        function changeLedger() {
            const select = document.getElementById('ledger-select');
            if (select.value === 'add_new') {
                const newName = prompt("è«‹è¼¸å…¥æ–°å¸³æœ¬åç¨± (ä¾‹å¦‚: ä¼´æ‰‹ç¦®ä»£è³¼)");
                if (newName) {
                    const key = 'ledger_' + Date.now();
                    expenses[key] = [];
                    // å¢åŠ é¸é …
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.text = newName;
                    select.add(opt, select.options[select.length-1]);
                    select.value = key;
                    currentLedger = key;
                } else {
                    select.value = 'main';
                }
            } else {
                currentLedger = select.value;
            }
            renderExpenses();
        }


        // --- 5. é›œé …åŠŸèƒ½ ---
        function switchTab(tab) {
            document.querySelectorAll('.content-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            if (tab === 'itinerary') {
                document.getElementById('itinerary-view').classList.add('active');
                document.querySelector('.bottom-nav button:nth-child(1)').classList.add('active');
            } else if (tab === 'tools') {
                document.getElementById('tools-view').classList.add('active');
                document.querySelector('.bottom-nav button:nth-child(2)').classList.add('active');
            } else {
                document.getElementById('accounting-view').classList.add('active');
                document.querySelector('.bottom-nav button:nth-child(3)').classList.add('active');
            }
        }

        function fetchWeather() {
            // é€™è£¡ä½¿ç”¨ wttr.in çš„ç°¡å–® JSON ä»‹é¢ï¼Œä¸éœ€è¦ Key
            // è‹¥è¦çœŸå¯¦å³æ™‚è³‡æ–™ï¼Œå»ºè­°æœªä¾†ä¸²æ¥ OpenWeatherMap
            const loc = data[currentDay].location || 'Bangkok';
            document.getElementById('weather-loc').innerText = loc;
            // æ¨¡æ“¬é¡¯ç¤º (å› ç‚º wttr.in åœ–ç‰‡åœ¨æŸäº›ç€è¦½å™¨æœ‰ CORS é™åˆ¶ï¼Œé€™è£¡ç”¨æ–‡å­—æ¨¡æ“¬)
            document.getElementById('weather-temp').innerText = "32Â°C æ™´æ™‚å¤šé›²"; 
        }

        // å•Ÿå‹•
        init();

    </script>
</body>
</html>
